{"ast":null,"code":"import _regeneratorRuntime from\"/Users/jstarry/Workspace/solana/break/client/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"/Users/jstarry/Workspace/solana/break/client/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import _slicedToArray from\"/Users/jstarry/Workspace/solana/break/client/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";import*as React from\"react\";import{useConnection}from\"./api\";import{sleep,reportError}from\"utils\";var POLL_INTERVAL_MS=20000;export var ActionType;(function(ActionType){ActionType[ActionType[\"Start\"]=0]=\"Start\";ActionType[ActionType[\"Stop\"]=1]=\"Stop\";ActionType[ActionType[\"Update\"]=2]=\"Update\";})(ActionType||(ActionType={}));function reducer(state,action){switch(action.type){case ActionType.Stop:{return{};}case ActionType.Update:{return Object.assign({},state,{blockhash:action.blockhash});}}}var StateContext=React.createContext(undefined);var DispatchContext=React.createContext(undefined);export function BlockhashProvider(_ref){var children=_ref.children;var _React$useReducer=React.useReducer(reducer,{}),_React$useReducer2=_slicedToArray(_React$useReducer,2),state=_React$useReducer2[0],dispatch=_React$useReducer2[1];var connection=useConnection();var connectionRef=React.useRef(connection);React.useEffect(function(){if(connection===undefined)return;connectionRef.current=connection;refresh(dispatch,connectionRef);var timerId=window.setInterval(function(){return refresh(dispatch,connectionRef);},POLL_INTERVAL_MS);return function(){clearInterval(timerId);dispatch({type:ActionType.Stop});};},[connection]);return/*#__PURE__*/React.createElement(StateContext.Provider,{value:state},/*#__PURE__*/React.createElement(DispatchContext.Provider,{value:dispatch},children));}export function useBlockhash(){var state=React.useContext(StateContext);if(!state){throw new Error(\"useBlockhash must be used within a BlockhashProvider\");}return state.blockhash;}function refresh(_x,_x2){return _refresh.apply(this,arguments);}function _refresh(){_refresh=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(dispatch,connectionRef){var blockhash,connection;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:blockhash=undefined;connection=connectionRef.current;if(!(connection===undefined)){_context.next=4;break;}return _context.abrupt(\"return\");case 4:if(!(blockhash===undefined&&connection===connectionRef.current)){_context.next=19;break;}_context.prev=5;_context.next=8;return connection.getRecentBlockhash(\"max\");case 8:blockhash=_context.sent.blockhash;dispatch({type:ActionType.Update,blockhash:blockhash});_context.next=17;break;case 12:_context.prev=12;_context.t0=_context[\"catch\"](5);reportError(_context.t0,\"Failed to refresh blockhash\");_context.next=17;return sleep(1000);case 17:_context.next=4;break;case 19:case\"end\":return _context.stop();}}},_callee,null,[[5,12]]);}));return _refresh.apply(this,arguments);}","map":{"version":3,"sources":["/Users/jstarry/Workspace/solana/break/client/src/providers/blockhash.tsx"],"names":["React","useConnection","sleep","reportError","POLL_INTERVAL_MS","ActionType","reducer","state","action","type","Stop","Update","Object","assign","blockhash","StateContext","createContext","undefined","DispatchContext","BlockhashProvider","children","useReducer","dispatch","connection","connectionRef","useRef","useEffect","current","refresh","timerId","window","setInterval","clearInterval","useBlockhash","useContext","Error","getRecentBlockhash"],"mappings":"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","sourcesContent":["import * as React from \"react\";\nimport { Blockhash, Connection } from \"@solana/web3.js\";\nimport { useConnection } from \"./api\";\nimport { sleep, reportError } from \"utils\";\n\nconst POLL_INTERVAL_MS = 20000;\n\nexport enum ActionType {\n  Start,\n  Stop,\n  Update,\n}\n\ninterface Stop {\n  type: ActionType.Stop;\n}\n\ninterface Update {\n  type: ActionType.Update;\n  blockhash: Blockhash;\n}\n\ninterface State {\n  blockhash?: Blockhash;\n}\n\ntype Action = Stop | Update;\ntype Dispatch = (action: Action) => void;\n\nfunction reducer(state: State, action: Action): State {\n  switch (action.type) {\n    case ActionType.Stop: {\n      return {};\n    }\n    case ActionType.Update: {\n      return Object.assign({}, state, {\n        blockhash: action.blockhash,\n      });\n    }\n  }\n}\n\nconst StateContext = React.createContext<State | undefined>(undefined);\nconst DispatchContext = React.createContext<Dispatch | undefined>(undefined);\n\ntype BlockhashProviderProps = { children: React.ReactNode };\nexport function BlockhashProvider({ children }: BlockhashProviderProps) {\n  const [state, dispatch] = React.useReducer(reducer, {});\n  const connection = useConnection();\n  const connectionRef = React.useRef(connection);\n\n  React.useEffect(() => {\n    if (connection === undefined) return;\n\n    connectionRef.current = connection;\n    refresh(dispatch, connectionRef);\n    const timerId = window.setInterval(\n      () => refresh(dispatch, connectionRef),\n      POLL_INTERVAL_MS\n    );\n\n    return () => {\n      clearInterval(timerId);\n      dispatch({ type: ActionType.Stop });\n    };\n  }, [connection]);\n\n  return (\n    <StateContext.Provider value={state}>\n      <DispatchContext.Provider value={dispatch}>\n        {children}\n      </DispatchContext.Provider>\n    </StateContext.Provider>\n  );\n}\n\nexport function useBlockhash() {\n  const state = React.useContext(StateContext);\n  if (!state) {\n    throw new Error(`useBlockhash must be used within a BlockhashProvider`);\n  }\n\n  return state.blockhash;\n}\n\nasync function refresh(\n  dispatch: Dispatch,\n  connectionRef: React.MutableRefObject<Connection | undefined>\n) {\n  let blockhash = undefined;\n  const connection = connectionRef.current;\n  if (connection === undefined) return;\n  while (blockhash === undefined && connection === connectionRef.current) {\n    try {\n      blockhash = (await connection.getRecentBlockhash(\"max\")).blockhash;\n      dispatch({ type: ActionType.Update, blockhash });\n    } catch (err) {\n      reportError(err, \"Failed to refresh blockhash\");\n      await sleep(1000);\n    }\n  }\n}\n"]},"metadata":{},"sourceType":"module"}