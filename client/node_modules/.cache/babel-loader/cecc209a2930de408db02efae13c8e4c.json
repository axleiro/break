{"ast":null,"code":"import _regeneratorRuntime from\"/Users/jstarry/Workspace/solana/break/client/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"/Users/jstarry/Workspace/solana/break/client/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import _slicedToArray from\"/Users/jstarry/Workspace/solana/break/client/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";import*as React from\"react\";import{useServer}from\".\";import{jsx as _jsx}from\"react/jsx-runtime\";var SocketContext=/*#__PURE__*/React.createContext(undefined);var ActiveUsersContext=/*#__PURE__*/React.createContext(undefined);var SWITCH_URL_CODE=4444;var socketCounter=0;export function SocketProvider(_ref){var children=_ref.children;var _React$useState=React.useState(undefined),_React$useState2=_slicedToArray(_React$useState,2),socket=_React$useState2[0],setSocket=_React$useState2[1];var _React$useState3=React.useState(1),_React$useState4=_slicedToArray(_React$useState3,2),activeUsers=_React$useState4[0],setActiveUsers=_React$useState4[1];var _useServer=useServer(),webSocketUrl=_useServer.webSocketUrl;React.useEffect(function(){newSocket(webSocketUrl,setSocket,setActiveUsers);},[webSocketUrl]);return/*#__PURE__*/_jsx(SocketContext.Provider,{value:socket===null||socket===void 0?void 0:socket.socket,children:/*#__PURE__*/_jsx(ActiveUsersContext.Provider,{value:activeUsers,children:children})});}function newSocket(webSocketUrl,setSocket,setActiveUsers){socketCounter++;var id=socketCounter;var socket;try{socket=new WebSocket(webSocketUrl);}catch(err){return;}socket.onopen=function(){return setSocket(function(serverSocket){if(!serverSocket||serverSocket.id<=id){if(serverSocket&&serverSocket.socket.readyState===WebSocket.OPEN){serverSocket.socket.close(SWITCH_URL_CODE);}return{socket:socket,id:id};}else{socket.close(SWITCH_URL_CODE);return serverSocket;}});};socket.onmessage=function(e){var data=JSON.parse(e.data);if(\"activeUsers\"in data){setActiveUsers(data.activeUsers);}};socket.onclose=/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(event){return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:setSocket(function(serverSocket){// Socket may have been updated already\nif(!serverSocket||serverSocket.id===id){// Reconnect if close was not explicit\nif(event.code!==SWITCH_URL_CODE){console.error(\"Socket closed, reconnecting...\");// TODO: Re-enable\n// reportError(new Error(\"Socket was closed\"), \"Socket closed\");\nsetTimeout(function(){newSocket(webSocketUrl,setSocket,setActiveUsers);},5000);}return undefined;}return serverSocket;});case 1:case\"end\":return _context.stop();}}},_callee);}));return function(_x){return _ref2.apply(this,arguments);};}();socket.onerror=/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(){return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:socket.close();case 1:case\"end\":return _context2.stop();}}},_callee2);}));return socket;}export function useSocket(){return React.useContext(SocketContext);}export function useActiveUsers(){var context=React.useContext(ActiveUsersContext);if(!context){throw new Error(\"useActiveUsers must be used within a SocketProvider\");}return context;}","map":{"version":3,"sources":["/Users/jstarry/Workspace/solana/break/client/src/providers/server/socket.tsx"],"names":["React","useServer","SocketContext","createContext","undefined","ActiveUsersContext","SWITCH_URL_CODE","socketCounter","SocketProvider","children","useState","socket","setSocket","activeUsers","setActiveUsers","webSocketUrl","useEffect","newSocket","id","WebSocket","err","onopen","serverSocket","readyState","OPEN","close","onmessage","e","data","JSON","parse","onclose","event","code","console","error","setTimeout","onerror","useSocket","useContext","useActiveUsers","context","Error"],"mappings":"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","sourcesContent":["import * as React from \"react\";\nimport { useServer } from \".\";\n\ntype SetSocket = React.Dispatch<React.SetStateAction<ServerSocket | undefined>>;\nconst SocketContext = React.createContext<WebSocket | undefined>(undefined);\n\ntype SetActiveUsers = React.Dispatch<React.SetStateAction<number>>;\nconst ActiveUsersContext = React.createContext<number | undefined>(undefined);\n\nconst SWITCH_URL_CODE = 4444;\n\ntype ServerSocket = {\n  socket: WebSocket;\n  id: number;\n};\n\nlet socketCounter = 0;\n\ntype SocketProviderProps = { children: React.ReactNode };\nexport function SocketProvider({ children }: SocketProviderProps) {\n  let [socket, setSocket] = React.useState<ServerSocket | undefined>(undefined);\n  let [activeUsers, setActiveUsers] = React.useState<number>(1);\n\n  const { webSocketUrl } = useServer();\n  React.useEffect(() => {\n    newSocket(webSocketUrl, setSocket, setActiveUsers);\n  }, [webSocketUrl]);\n\n  return (\n    <SocketContext.Provider value={socket?.socket}>\n      <ActiveUsersContext.Provider value={activeUsers}>\n        {children}\n      </ActiveUsersContext.Provider>\n    </SocketContext.Provider>\n  );\n}\n\nfunction newSocket(\n  webSocketUrl: string,\n  setSocket: SetSocket,\n  setActiveUsers: SetActiveUsers\n): WebSocket | undefined {\n  socketCounter++;\n  const id = socketCounter;\n\n  let socket: WebSocket;\n  try {\n    socket = new WebSocket(webSocketUrl);\n  } catch (err) {\n    return;\n  }\n\n  socket.onopen = () =>\n    setSocket((serverSocket) => {\n      if (!serverSocket || serverSocket.id <= id) {\n        if (serverSocket && serverSocket.socket.readyState === WebSocket.OPEN) {\n          serverSocket.socket.close(SWITCH_URL_CODE);\n        }\n        return { socket, id };\n      } else {\n        socket.close(SWITCH_URL_CODE);\n        return serverSocket;\n      }\n    });\n\n  socket.onmessage = (e) => {\n    const data = JSON.parse(e.data);\n    if (\"activeUsers\" in data) {\n      setActiveUsers(data.activeUsers);\n    }\n  };\n\n  socket.onclose = async (event) => {\n    setSocket((serverSocket) => {\n      // Socket may have been updated already\n      if (!serverSocket || serverSocket.id === id) {\n        // Reconnect if close was not explicit\n        if (event.code !== SWITCH_URL_CODE) {\n          console.error(\"Socket closed, reconnecting...\");\n          // TODO: Re-enable\n          // reportError(new Error(\"Socket was closed\"), \"Socket closed\");\n          setTimeout(() => {\n            newSocket(webSocketUrl, setSocket, setActiveUsers);\n          }, 5000);\n        }\n        return undefined;\n      }\n      return serverSocket;\n    });\n  };\n\n  socket.onerror = async () => {\n    socket.close();\n  };\n\n  return socket;\n}\n\nexport function useSocket() {\n  return React.useContext(SocketContext);\n}\n\nexport function useActiveUsers() {\n  const context = React.useContext(ActiveUsersContext);\n  if (!context) {\n    throw new Error(`useActiveUsers must be used within a SocketProvider`);\n  }\n\n  return context;\n}\n"]},"metadata":{},"sourceType":"module"}