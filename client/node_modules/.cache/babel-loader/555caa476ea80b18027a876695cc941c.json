{"ast":null,"code":"import _objectSpread from\"/Users/jstarry/Workspace/solana/break/client/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/objectSpread2\";import _regeneratorRuntime from\"/Users/jstarry/Workspace/solana/break/client/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"/Users/jstarry/Workspace/solana/break/client/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import _slicedToArray from\"/Users/jstarry/Workspace/solana/break/client/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";import{Fragment as _Fragment}from\"react/jsx-runtime\";import*as React from\"react\";import{useHistory,useLocation}from\"react-router-dom\";import nacl from\"tweetnacl\";import NodeDetailsManager from\"@toruslabs/fetch-node-details\";import Torus from\"@toruslabs/torus.js\";import{Account}from\"@solana/web3.js\";import{Header}from\"components/Header\";import{LoadingModal}from\"components/LoadingModal\";import{usePayerState}from\"providers/wallet\";import{useGoogleLogin}from\"react-google-login\";import{PAYMENT_ACCOUNT,reportError}from\"utils\";import{useGameState}from\"providers/game\";var origin=window.location.origin;var USE_TORUS_TESTNET=origin===\"http://localhost:3000\";// Torus is only enabled for authorized domains\nvar ENABLE_TORUS=USE_TORUS_TESTNET||origin===\"https://break.solana.com\"||origin===\"https://staging.break.solana.com\";var CLIENT_ID=\"785716588020-b5a4fheugq38c23do3p2l73iumfrklnr.apps.googleusercontent.com\";var TEST_CLIENT_ID=\"785716588020-p8kdid1dltqsafcl23g82fb9funikaj7.apps.googleusercontent.com\";var VERIFIER=\"breaksolana-google\";var NODE_DETAILS=USE_TORUS_TESTNET?new NodeDetailsManager({network:\"ropsten\",proxyAddress:\"0x4023d2a0D330bF11426B12C6144Cfb96B7fa6183\"}):new NodeDetailsManager();export default function Setup(){var _usePayerState=usePayerState(),_usePayerState2=_slicedToArray(_usePayerState,2),payer=_usePayerState2[0],setPayer=_usePayerState2[1];var gameState=useGameState();var _React$useState=React.useState(),_React$useState2=_slicedToArray(_React$useState,2),googleStatus=_React$useState2[0],setGoogleStatus=_React$useState2[1];var _React$useState3=React.useState(),_React$useState4=_slicedToArray(_React$useState3,2),googleResponse=_React$useState4[0],setGoogleResponse=_React$useState4[1];var _React$useState5=React.useState(),_React$useState6=_slicedToArray(_React$useState5,2),nodeDetails=_React$useState6[0],setNodeDetails=_React$useState6[1];var history=useHistory();var location=useLocation();var _React$useState7=React.useState(\"\"),_React$useState8=_slicedToArray(_React$useState7,2),error=_React$useState8[0],setError=_React$useState8[1];var responseGoogle=React.useCallback(/*#__PURE__*/function(){var _ref=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(response){return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:if(!(\"code\"in response)){setGoogleResponse(response);}case 1:case\"end\":return _context.stop();}}},_callee);}));return function(_x){return _ref.apply(this,arguments);};}(),[]);var disconnectGoogle=React.useCallback(function(){if(!googleResponse)return;googleResponse.disconnect();setGoogleResponse(undefined);},[googleResponse]);var _useGoogleLogin=useGoogleLogin({clientId:USE_TORUS_TESTNET?TEST_CLIENT_ID:CLIENT_ID,onSuccess:responseGoogle,onFailure:function onFailure(err){if(!ENABLE_TORUS)return;reportError(err,\"Google login failed\");setGoogleStatus(undefined);setError(\"Failed to login\");},isSignedIn:ENABLE_TORUS}),signIn=_useGoogleLogin.signIn,loaded=_useGoogleLogin.loaded;var onSignIn=React.useCallback(function(status){setGoogleStatus(status);if(status===\"fresh\"){disconnectGoogle();signIn();}},[disconnectGoogle,signIn]);React.useEffect(function(){if(!ENABLE_TORUS)return;var unmounted=false;NODE_DETAILS.getNodeDetails().then(function(details){!unmounted&&setNodeDetails(details);}).catch(function(err){reportError(err,\"Fetching torus node details\");});return function(){unmounted=true;};},[]);React.useEffect(function(){if(!nodeDetails||!googleResponse||!googleStatus)return;var unmounted=false;_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(){var torus,torusNodeEndpoints,torusNodePub,torusIndexes,verifierId,idToken,_yield$torus$retrieve,privKey,torusKey,keyPair;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:torus=new Torus({});torusNodeEndpoints=nodeDetails.torusNodeEndpoints,torusNodePub=nodeDetails.torusNodePub,torusIndexes=nodeDetails.torusIndexes;_context2.prev=2;verifierId=googleResponse.getBasicProfile().getEmail();// Creates a new key for the verifierId if it doesn't exist yet\n_context2.next=6;return torus.getPublicAddress(torusNodeEndpoints,torusNodePub,{verifier:VERIFIER,verifierId:verifierId},false);case 6:idToken=googleResponse.getAuthResponse().id_token;if(!(googleStatus===\"cached\")){_context2.next=11;break;}_context2.next=10;return googleResponse.reloadAuthResponse();case 10:idToken=_context2.sent.id_token;case 11:_context2.next=13;return torus.retrieveShares(torusNodeEndpoints,torusIndexes,VERIFIER,{verifier_id:verifierId},idToken);case 13:_yield$torus$retrieve=_context2.sent;privKey=_yield$torus$retrieve.privKey;if(!unmounted){_context2.next=17;break;}return _context2.abrupt(\"return\");case 17:torusKey=Buffer.from(privKey.toString(),\"hex\");keyPair=nacl.sign.keyPair.fromSeed(torusKey);setPayer(new Account(keyPair.secretKey));_context2.next=27;break;case 22:_context2.prev=22;_context2.t0=_context2[\"catch\"](2);reportError(_context2.t0,\"failed to fetch torus key\");setGoogleStatus(undefined);setError(\"Failed to fetch Torus key\");case 27:case\"end\":return _context2.stop();}}},_callee2,null,[[2,22]]);}))();return function(){unmounted=true;};},[nodeDetails,googleResponse,googleStatus,setPayer]);React.useEffect(function(){if(gameState!==\"payment\"||payer){history.push(_objectSpread(_objectSpread({},location),{},{pathname:\"/game\"}));}},[gameState,payer,history,location]);var loadingWallet=!!googleResponse;var showWalletSetup=loaded&&!googleStatus||error||!ENABLE_TORUS;var showLoading=!showWalletSetup;return/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(\"div\",{className:\"modal z-auto fade\".concat(showWalletSetup?\" show\":\"\"),children:/*#__PURE__*/_jsx(\"div\",{className:\"modal-dialog modal-dialog-centered\",children:/*#__PURE__*/_jsx(\"div\",{className:\"modal-content\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"modal-card card mb-0\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"card-header\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"flex-shrink-0 flex-basis-auto\",children:\"Select Wallet\"}),/*#__PURE__*/_jsx(\"div\",{className:\"text-truncate text-warning small ml-5\",children:error})]}),/*#__PURE__*/_jsx(\"div\",{className:\"card-body\",children:/*#__PURE__*/_jsxs(\"ul\",{className:\"list-group list-group-flush list my-n4\",children:[googleResponse&&/*#__PURE__*/_jsx(\"li\",{className:\"list-group-item\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"row align-items-center\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"col\",children:[/*#__PURE__*/_jsx(\"h4\",{className:\"mb-1\",children:\"Current wallet\"}),/*#__PURE__*/_jsxs(\"p\",{className:\"small mb-0 text-muted\",children:[\"Account:\",\" \",/*#__PURE__*/_jsx(\"span\",{className:\"text-primary\",children:googleResponse.getBasicProfile().getEmail()})]})]}),/*#__PURE__*/_jsx(\"div\",{className:\"col-auto\",children:/*#__PURE__*/_jsx(\"span\",{className:\"btn btn-primary\",onClick:function onClick(){return onSignIn(\"cached\");},children:\"Select\"})})]})}),ENABLE_TORUS&&/*#__PURE__*/_jsx(\"li\",{className:\"list-group-item\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"row align-items-center\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"col\",children:[/*#__PURE__*/_jsx(\"h4\",{className:\"mb-1\",children:\"Recoverable wallet\"}),/*#__PURE__*/_jsxs(\"p\",{className:\"small mb-0 text-muted\",children:[\"Powered by \",/*#__PURE__*/_jsx(\"a\",{href:\"https://tor.us/\",children:\"Torus\"})]})]}),/*#__PURE__*/_jsx(\"div\",{className:\"col-auto\",children:/*#__PURE__*/_jsx(\"span\",{className:\"btn btn-white\",onClick:function onClick(){return onSignIn(\"fresh\");},children:/*#__PURE__*/_jsx(\"img\",{height:\"18\",width:\"18\",src:\"/google.svg\",className:\"mt-n1\",alt:\"Google\"})})})]})}),/*#__PURE__*/_jsx(\"li\",{className:\"list-group-item\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"row align-items-center\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"col\",children:[/*#__PURE__*/_jsx(\"h4\",{className:\"mb-1\",children:\"Local wallet\"}),/*#__PURE__*/_jsx(\"p\",{className:\"small mb-0 text-muted\",children:\"Saved to browser storage\"})]}),/*#__PURE__*/_jsx(\"div\",{className:\"col-auto\",children:/*#__PURE__*/_jsx(\"span\",{className:\"btn btn-white\",onClick:function onClick(){disconnectGoogle();setPayer(PAYMENT_ACCOUNT);},children:\"Select\"})})]})})]})})]})})})}),/*#__PURE__*/_jsx(\"div\",{className:\"container min-vh-100 d-flex flex-column\",children:/*#__PURE__*/_jsx(Header,{})}),/*#__PURE__*/_jsx(LoadingModal,{show:showLoading,wallet:loadingWallet}),/*#__PURE__*/_jsx(Overlay,{show:showLoading})]});}function Overlay(_ref3){var show=_ref3.show;if(show)return/*#__PURE__*/_jsx(\"div\",{className:\"modal-backdrop fade show\"});return/*#__PURE__*/_jsx(\"div\",{className:\"fade\"});}","map":{"version":3,"sources":["/Users/jstarry/Workspace/solana/break/client/src/pages/SetupPage.tsx"],"names":["React","useHistory","useLocation","nacl","NodeDetailsManager","Torus","Account","Header","LoadingModal","usePayerState","useGoogleLogin","PAYMENT_ACCOUNT","reportError","useGameState","origin","window","location","USE_TORUS_TESTNET","ENABLE_TORUS","CLIENT_ID","TEST_CLIENT_ID","VERIFIER","NODE_DETAILS","network","proxyAddress","Setup","payer","setPayer","gameState","useState","googleStatus","setGoogleStatus","googleResponse","setGoogleResponse","nodeDetails","setNodeDetails","history","error","setError","responseGoogle","useCallback","response","disconnectGoogle","disconnect","undefined","clientId","onSuccess","onFailure","err","isSignedIn","signIn","loaded","onSignIn","status","useEffect","unmounted","getNodeDetails","then","details","catch","torus","torusNodeEndpoints","torusNodePub","torusIndexes","verifierId","getBasicProfile","getEmail","getPublicAddress","verifier","idToken","getAuthResponse","id_token","reloadAuthResponse","retrieveShares","verifier_id","privKey","torusKey","Buffer","from","toString","keyPair","sign","fromSeed","secretKey","push","pathname","loadingWallet","showWalletSetup","showLoading","Overlay","show"],"mappings":"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","sourcesContent":["import * as React from \"react\";\nimport { useHistory, useLocation } from \"react-router-dom\";\nimport nacl from \"tweetnacl\";\nimport NodeDetailsManager from \"@toruslabs/fetch-node-details\";\nimport Torus from \"@toruslabs/torus.js\";\nimport { Account } from \"@solana/web3.js\";\n\nimport { Header } from \"components/Header\";\nimport { LoadingModal } from \"components/LoadingModal\";\nimport { usePayerState } from \"providers/wallet\";\nimport {\n  useGoogleLogin,\n  GoogleLoginResponse,\n  GoogleLoginResponseOffline,\n} from \"react-google-login\";\nimport { PAYMENT_ACCOUNT, reportError } from \"utils\";\nimport { useGameState } from \"providers/game\";\n\nconst origin = window.location.origin;\nconst USE_TORUS_TESTNET = origin === \"http://localhost:3000\";\n\n// Torus is only enabled for authorized domains\nconst ENABLE_TORUS =\n  USE_TORUS_TESTNET ||\n  origin === \"https://break.solana.com\" ||\n  origin === \"https://staging.break.solana.com\";\n\ntype NodeDetails = {\n  torusNodeEndpoints: any;\n  torusIndexes: any;\n  torusNodePub: any;\n};\n\nconst CLIENT_ID =\n  \"785716588020-b5a4fheugq38c23do3p2l73iumfrklnr.apps.googleusercontent.com\";\nconst TEST_CLIENT_ID =\n  \"785716588020-p8kdid1dltqsafcl23g82fb9funikaj7.apps.googleusercontent.com\";\nconst VERIFIER = \"breaksolana-google\";\n\nconst NODE_DETAILS = USE_TORUS_TESTNET\n  ? new NodeDetailsManager({\n      network: \"ropsten\",\n      proxyAddress: \"0x4023d2a0D330bF11426B12C6144Cfb96B7fa6183\",\n    })\n  : (new (NodeDetailsManager as any)() as NodeDetailsManager);\n\ntype GoogleStatus = \"cached\" | \"fresh\";\nexport default function Setup() {\n  const [payer, setPayer] = usePayerState();\n  const gameState = useGameState();\n  const [googleStatus, setGoogleStatus] = React.useState<GoogleStatus>();\n  const [googleResponse, setGoogleResponse] = React.useState<\n    GoogleLoginResponse\n  >();\n  const [nodeDetails, setNodeDetails] = React.useState<NodeDetails>();\n  const history = useHistory();\n  const location = useLocation();\n  const [error, setError] = React.useState(\"\");\n\n  const responseGoogle = React.useCallback(\n    async (response: GoogleLoginResponse | GoogleLoginResponseOffline) => {\n      if (!(\"code\" in response)) {\n        setGoogleResponse(response);\n      }\n    },\n    []\n  );\n\n  const disconnectGoogle = React.useCallback(() => {\n    if (!googleResponse) return;\n    googleResponse.disconnect();\n    setGoogleResponse(undefined);\n  }, [googleResponse]);\n\n  const { signIn, loaded } = useGoogleLogin({\n    clientId: USE_TORUS_TESTNET ? TEST_CLIENT_ID : CLIENT_ID,\n    onSuccess: responseGoogle,\n    onFailure: (err) => {\n      if (!ENABLE_TORUS) return;\n      reportError(err, \"Google login failed\");\n      setGoogleStatus(undefined);\n      setError(\"Failed to login\");\n    },\n    isSignedIn: ENABLE_TORUS,\n  });\n\n  const onSignIn = React.useCallback(\n    (status: GoogleStatus) => {\n      setGoogleStatus(status);\n      if (status === \"fresh\") {\n        disconnectGoogle();\n        signIn();\n      }\n    },\n    [disconnectGoogle, signIn]\n  );\n\n  React.useEffect(() => {\n    if (!ENABLE_TORUS) return;\n\n    let unmounted = false;\n    NODE_DETAILS.getNodeDetails()\n      .then((details) => {\n        !unmounted && setNodeDetails(details);\n      })\n      .catch((err) => {\n        reportError(err, \"Fetching torus node details\");\n      });\n\n    return () => {\n      unmounted = true;\n    };\n  }, []);\n\n  React.useEffect(() => {\n    if (!nodeDetails || !googleResponse || !googleStatus) return;\n\n    let unmounted = false;\n    (async () => {\n      const torus = new Torus({});\n      const { torusNodeEndpoints, torusNodePub, torusIndexes } = nodeDetails;\n\n      try {\n        const verifierId = googleResponse.getBasicProfile().getEmail();\n\n        // Creates a new key for the verifierId if it doesn't exist yet\n        await torus.getPublicAddress(\n          torusNodeEndpoints,\n          torusNodePub,\n          { verifier: VERIFIER, verifierId },\n          false\n        );\n\n        let idToken = googleResponse.getAuthResponse().id_token;\n        if (googleStatus === \"cached\") {\n          idToken = (await googleResponse.reloadAuthResponse()).id_token;\n        }\n\n        const { privKey } = await torus.retrieveShares(\n          torusNodeEndpoints,\n          torusIndexes,\n          VERIFIER,\n          { verifier_id: verifierId },\n          idToken\n        );\n        if (unmounted) return;\n        const torusKey = Buffer.from(privKey.toString(), \"hex\");\n        const keyPair = nacl.sign.keyPair.fromSeed(torusKey);\n        setPayer(new Account(keyPair.secretKey));\n      } catch (err) {\n        reportError(err, \"failed to fetch torus key\");\n        setGoogleStatus(undefined);\n        setError(\"Failed to fetch Torus key\");\n      }\n    })();\n\n    return () => {\n      unmounted = true;\n    };\n  }, [nodeDetails, googleResponse, googleStatus, setPayer]);\n\n  React.useEffect(() => {\n    if (gameState !== \"payment\" || payer) {\n      history.push({ ...location, pathname: \"/game\" });\n    }\n  }, [gameState, payer, history, location]);\n\n  const loadingWallet = !!googleResponse;\n  const showWalletSetup = (loaded && !googleStatus) || error || !ENABLE_TORUS;\n  const showLoading = !showWalletSetup;\n  return (\n    <>\n      <div className={`modal z-auto fade${showWalletSetup ? \" show\" : \"\"}`}>\n        <div className=\"modal-dialog modal-dialog-centered\">\n          <div className=\"modal-content\">\n            <div className=\"modal-card card mb-0\">\n              <div className=\"card-header\">\n                <div className=\"flex-shrink-0 flex-basis-auto\">\n                  Select Wallet\n                </div>\n                <div className=\"text-truncate text-warning small ml-5\">\n                  {error}\n                </div>\n              </div>\n\n              <div className=\"card-body\">\n                <ul className=\"list-group list-group-flush list my-n4\">\n                  {googleResponse && (\n                    <li className=\"list-group-item\">\n                      <div className=\"row align-items-center\">\n                        <div className=\"col\">\n                          <h4 className=\"mb-1\">Current wallet</h4>\n                          <p className=\"small mb-0 text-muted\">\n                            Account:{\" \"}\n                            <span className=\"text-primary\">\n                              {googleResponse.getBasicProfile().getEmail()}\n                            </span>\n                          </p>\n                        </div>\n                        <div className=\"col-auto\">\n                          <span\n                            className=\"btn btn-primary\"\n                            onClick={() => onSignIn(\"cached\")}\n                          >\n                            Select\n                          </span>\n                        </div>\n                      </div>\n                    </li>\n                  )}\n\n                  {ENABLE_TORUS && (\n                    <li className=\"list-group-item\">\n                      <div className=\"row align-items-center\">\n                        <div className=\"col\">\n                          <h4 className=\"mb-1\">Recoverable wallet</h4>\n                          <p className=\"small mb-0 text-muted\">\n                            Powered by <a href=\"https://tor.us/\">Torus</a>\n                          </p>\n                        </div>\n                        <div className=\"col-auto\">\n                          <span\n                            className=\"btn btn-white\"\n                            onClick={() => onSignIn(\"fresh\")}\n                          >\n                            <img\n                              height=\"18\"\n                              width=\"18\"\n                              src=\"/google.svg\"\n                              className=\"mt-n1\"\n                              alt=\"Google\"\n                            />\n                          </span>\n                        </div>\n                      </div>\n                    </li>\n                  )}\n\n                  <li className=\"list-group-item\">\n                    <div className=\"row align-items-center\">\n                      <div className=\"col\">\n                        <h4 className=\"mb-1\">Local wallet</h4>\n                        <p className=\"small mb-0 text-muted\">\n                          Saved to browser storage\n                        </p>\n                      </div>\n                      <div className=\"col-auto\">\n                        <span\n                          className=\"btn btn-white\"\n                          onClick={() => {\n                            disconnectGoogle();\n                            setPayer(PAYMENT_ACCOUNT);\n                          }}\n                        >\n                          Select\n                        </span>\n                      </div>\n                    </div>\n                  </li>\n                </ul>\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n      <div className=\"container min-vh-100 d-flex flex-column\">\n        <Header />\n      </div>\n      <LoadingModal show={showLoading} wallet={loadingWallet} />\n      <Overlay show={showLoading} />\n    </>\n  );\n}\n\nfunction Overlay({ show }: { show: boolean }) {\n  if (show) return <div className=\"modal-backdrop fade show\"></div>;\n  return <div className=\"fade\"></div>;\n}\n"]},"metadata":{},"sourceType":"module"}