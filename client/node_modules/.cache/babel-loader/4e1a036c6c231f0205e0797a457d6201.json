{"ast":null,"code":"var _jsxFileName = \"/Users/jstarry/Workspace/solana/break/client/src/providers/socket.tsx\";\nimport * as React from \"react\";\nimport { useServer } from \"./server\";\nimport { reportError } from \"utils\";\nconst SocketContext = React.createContext(undefined);\nconst ActiveUsersContext = React.createContext(undefined);\nconst SWITCH_URL_CODE = 4444;\nlet socketCounter = 0;\nexport function SocketProvider({\n  children\n}) {\n  let [socket, setSocket] = React.useState(undefined);\n  let [activeUsers, setActiveUsers] = React.useState(1);\n  const {\n    webSocketUrl\n  } = useServer();\n  React.useEffect(() => {\n    newSocket(webSocketUrl, setSocket, setActiveUsers);\n  }, [webSocketUrl]);\n  return /*#__PURE__*/React.createElement(SocketContext.Provider, {\n    value: socket === null || socket === void 0 ? void 0 : socket.socket,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 31,\n      columnNumber: 5\n    }\n  }, /*#__PURE__*/React.createElement(ActiveUsersContext.Provider, {\n    value: activeUsers,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 32,\n      columnNumber: 7\n    }\n  }, children));\n}\n\nfunction newSocket(webSocketUrl, setSocket, setActiveUsers) {\n  socketCounter++;\n  const id = socketCounter;\n  const socket = new WebSocket(webSocketUrl);\n\n  socket.onopen = () => setSocket(serverSocket => {\n    if (!serverSocket || serverSocket.id <= id) {\n      if (serverSocket && serverSocket.socket.readyState === WebSocket.OPEN) {\n        serverSocket.socket.close(SWITCH_URL_CODE);\n      }\n\n      return {\n        socket,\n        id\n      };\n    } else {\n      socket.close(SWITCH_URL_CODE);\n      return serverSocket;\n    }\n  });\n\n  socket.onmessage = e => {\n    const data = JSON.parse(e.data);\n\n    if (\"activeUsers\" in data) {\n      setActiveUsers(data.activeUsers);\n    }\n  };\n\n  socket.onclose = async event => {\n    setSocket(serverSocket => {\n      // Socket may have been updated already\n      if (!serverSocket || serverSocket.id === id) {\n        // Reconnect if close was not explicit\n        if (event.code !== SWITCH_URL_CODE) {\n          reportError(new Error(\"Socket was closed\"), \"Socket closed\");\n          setTimeout(() => {\n            newSocket(webSocketUrl, setSocket, setActiveUsers);\n          }, 5000);\n        }\n\n        return undefined;\n      }\n\n      return serverSocket;\n    });\n  };\n\n  socket.onerror = async () => {\n    socket.close();\n  };\n\n  return socket;\n}\n\nexport function useSocket() {\n  return React.useContext(SocketContext);\n}\nexport function useActiveUsers() {\n  const context = React.useContext(ActiveUsersContext);\n\n  if (!context) {\n    throw new Error(`useActiveUsers must be used within a SocketProvider`);\n  }\n\n  return context;\n}","map":{"version":3,"sources":["/Users/jstarry/Workspace/solana/break/client/src/providers/socket.tsx"],"names":["React","useServer","reportError","SocketContext","createContext","undefined","ActiveUsersContext","SWITCH_URL_CODE","socketCounter","SocketProvider","children","socket","setSocket","useState","activeUsers","setActiveUsers","webSocketUrl","useEffect","newSocket","id","WebSocket","onopen","serverSocket","readyState","OPEN","close","onmessage","e","data","JSON","parse","onclose","event","code","Error","setTimeout","onerror","useSocket","useContext","useActiveUsers","context"],"mappings":"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","sourcesContent":["import * as React from \"react\";\nimport { useServer } from \"./server\";\nimport { reportError } from \"utils\";\n\ntype SetSocket = React.Dispatch<React.SetStateAction<ServerSocket | undefined>>;\nconst SocketContext = React.createContext<WebSocket | undefined>(undefined);\n\ntype SetActiveUsers = React.Dispatch<React.SetStateAction<number>>;\nconst ActiveUsersContext = React.createContext<number | undefined>(undefined);\n\nconst SWITCH_URL_CODE = 4444;\n\ntype ServerSocket = {\n  socket: WebSocket;\n  id: number;\n};\n\nlet socketCounter = 0;\n\ntype SocketProviderProps = { children: React.ReactNode };\nexport function SocketProvider({ children }: SocketProviderProps) {\n  let [socket, setSocket] = React.useState<ServerSocket | undefined>(undefined);\n  let [activeUsers, setActiveUsers] = React.useState<number>(1);\n\n  const { webSocketUrl } = useServer();\n  React.useEffect(() => {\n    newSocket(webSocketUrl, setSocket, setActiveUsers);\n  }, [webSocketUrl]);\n\n  return (\n    <SocketContext.Provider value={socket?.socket}>\n      <ActiveUsersContext.Provider value={activeUsers}>\n        {children}\n      </ActiveUsersContext.Provider>\n    </SocketContext.Provider>\n  );\n}\n\nfunction newSocket(\n  webSocketUrl: string,\n  setSocket: SetSocket,\n  setActiveUsers: SetActiveUsers\n): WebSocket {\n  socketCounter++;\n  const id = socketCounter;\n  const socket = new WebSocket(webSocketUrl);\n  socket.onopen = () =>\n    setSocket((serverSocket) => {\n      if (!serverSocket || serverSocket.id <= id) {\n        if (serverSocket && serverSocket.socket.readyState === WebSocket.OPEN) {\n          serverSocket.socket.close(SWITCH_URL_CODE);\n        }\n        return { socket, id };\n      } else {\n        socket.close(SWITCH_URL_CODE);\n        return serverSocket;\n      }\n    });\n\n  socket.onmessage = (e) => {\n    const data = JSON.parse(e.data);\n    if (\"activeUsers\" in data) {\n      setActiveUsers(data.activeUsers);\n    }\n  };\n\n  socket.onclose = async (event) => {\n    setSocket((serverSocket) => {\n      // Socket may have been updated already\n      if (!serverSocket || serverSocket.id === id) {\n        // Reconnect if close was not explicit\n        if (event.code !== SWITCH_URL_CODE) {\n          reportError(new Error(\"Socket was closed\"), \"Socket closed\");\n          setTimeout(() => {\n            newSocket(webSocketUrl, setSocket, setActiveUsers);\n          }, 5000);\n        }\n        return undefined;\n      }\n      return serverSocket;\n    });\n  };\n\n  socket.onerror = async () => {\n    socket.close();\n  };\n\n  return socket;\n}\n\nexport function useSocket() {\n  return React.useContext(SocketContext);\n}\n\nexport function useActiveUsers() {\n  const context = React.useContext(ActiveUsersContext);\n  if (!context) {\n    throw new Error(`useActiveUsers must be used within a SocketProvider`);\n  }\n\n  return context;\n}\n"]},"metadata":{},"sourceType":"module"}