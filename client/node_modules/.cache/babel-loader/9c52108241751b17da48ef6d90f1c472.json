{"ast":null,"code":"import _regeneratorRuntime from\"/Users/jstarry/Workspace/solana/break/client/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"/Users/jstarry/Workspace/solana/break/client/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import _slicedToArray from\"/Users/jstarry/Workspace/solana/break/client/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";import*as React from\"react\";import{useServer}from\"./server\";import{reportError}from\"utils\";var SocketContext=React.createContext(undefined);var ActiveUsersContext=React.createContext(undefined);var SWITCH_URL_CODE=4444;var socketCounter=0;export function SocketProvider(_ref){var children=_ref.children;var _React$useState=React.useState(undefined),_React$useState2=_slicedToArray(_React$useState,2),socket=_React$useState2[0],setSocket=_React$useState2[1];var _React$useState3=React.useState(1),_React$useState4=_slicedToArray(_React$useState3,2),activeUsers=_React$useState4[0],setActiveUsers=_React$useState4[1];var _useServer=useServer(),webSocketUrl=_useServer.webSocketUrl;React.useEffect(function(){newSocket(webSocketUrl,setSocket,setActiveUsers);},[webSocketUrl]);return/*#__PURE__*/React.createElement(SocketContext.Provider,{value:socket===null||socket===void 0?void 0:socket.socket},/*#__PURE__*/React.createElement(ActiveUsersContext.Provider,{value:activeUsers},children));}function newSocket(webSocketUrl,setSocket,setActiveUsers){socketCounter++;var id=socketCounter;var socket=new WebSocket(webSocketUrl);socket.onopen=function(){return setSocket(function(serverSocket){if(!serverSocket||serverSocket.id<=id){if(serverSocket&&serverSocket.socket.readyState===WebSocket.OPEN){serverSocket.socket.close(SWITCH_URL_CODE);}return{socket:socket,id:id};}else{socket.close(SWITCH_URL_CODE);return serverSocket;}});};socket.onmessage=function(e){var data=JSON.parse(e.data);if(\"activeUsers\"in data){setActiveUsers(data.activeUsers);}};socket.onclose=/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(event){return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:setSocket(function(serverSocket){// Socket may have been updated already\nif(!serverSocket||serverSocket.id===id){// Reconnect if close was not explicit\nif(event.code!==SWITCH_URL_CODE){reportError(new Error(\"Socket was closed\"),\"Socket closed\");setTimeout(function(){newSocket(webSocketUrl,setSocket,setActiveUsers);},5000);}return undefined;}return serverSocket;});case 1:case\"end\":return _context.stop();}}},_callee);}));return function(_x){return _ref2.apply(this,arguments);};}();socket.onerror=/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(){return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:socket.close();case 1:case\"end\":return _context2.stop();}}},_callee2);}));return socket;}export function useSocket(){return React.useContext(SocketContext);}export function useActiveUsers(){var context=React.useContext(ActiveUsersContext);if(!context){throw new Error(\"useActiveUsers must be used within a SocketProvider\");}return context;}","map":{"version":3,"sources":["/Users/jstarry/Workspace/solana/break/client/src/providers/socket.tsx"],"names":["React","useServer","reportError","SocketContext","createContext","undefined","ActiveUsersContext","SWITCH_URL_CODE","socketCounter","SocketProvider","children","useState","socket","setSocket","activeUsers","setActiveUsers","webSocketUrl","useEffect","newSocket","id","WebSocket","onopen","serverSocket","readyState","OPEN","close","onmessage","e","data","JSON","parse","onclose","event","code","Error","setTimeout","onerror","useSocket","useContext","useActiveUsers","context"],"mappings":"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","sourcesContent":["import * as React from \"react\";\nimport { useServer } from \"./server\";\nimport { reportError } from \"utils\";\n\ntype SetSocket = React.Dispatch<React.SetStateAction<ServerSocket | undefined>>;\nconst SocketContext = React.createContext<WebSocket | undefined>(undefined);\n\ntype SetActiveUsers = React.Dispatch<React.SetStateAction<number>>;\nconst ActiveUsersContext = React.createContext<number | undefined>(undefined);\n\nconst SWITCH_URL_CODE = 4444;\n\ntype ServerSocket = {\n  socket: WebSocket;\n  id: number;\n};\n\nlet socketCounter = 0;\n\ntype SocketProviderProps = { children: React.ReactNode };\nexport function SocketProvider({ children }: SocketProviderProps) {\n  let [socket, setSocket] = React.useState<ServerSocket | undefined>(undefined);\n  let [activeUsers, setActiveUsers] = React.useState<number>(1);\n\n  const { webSocketUrl } = useServer();\n  React.useEffect(() => {\n    newSocket(webSocketUrl, setSocket, setActiveUsers);\n  }, [webSocketUrl]);\n\n  return (\n    <SocketContext.Provider value={socket?.socket}>\n      <ActiveUsersContext.Provider value={activeUsers}>\n        {children}\n      </ActiveUsersContext.Provider>\n    </SocketContext.Provider>\n  );\n}\n\nfunction newSocket(\n  webSocketUrl: string,\n  setSocket: SetSocket,\n  setActiveUsers: SetActiveUsers\n): WebSocket {\n  socketCounter++;\n  const id = socketCounter;\n  const socket = new WebSocket(webSocketUrl);\n  socket.onopen = () =>\n    setSocket((serverSocket) => {\n      if (!serverSocket || serverSocket.id <= id) {\n        if (serverSocket && serverSocket.socket.readyState === WebSocket.OPEN) {\n          serverSocket.socket.close(SWITCH_URL_CODE);\n        }\n        return { socket, id };\n      } else {\n        socket.close(SWITCH_URL_CODE);\n        return serverSocket;\n      }\n    });\n\n  socket.onmessage = (e) => {\n    const data = JSON.parse(e.data);\n    if (\"activeUsers\" in data) {\n      setActiveUsers(data.activeUsers);\n    }\n  };\n\n  socket.onclose = async (event) => {\n    setSocket((serverSocket) => {\n      // Socket may have been updated already\n      if (!serverSocket || serverSocket.id === id) {\n        // Reconnect if close was not explicit\n        if (event.code !== SWITCH_URL_CODE) {\n          reportError(new Error(\"Socket was closed\"), \"Socket closed\");\n          setTimeout(() => {\n            newSocket(webSocketUrl, setSocket, setActiveUsers);\n          }, 5000);\n        }\n        return undefined;\n      }\n      return serverSocket;\n    });\n  };\n\n  socket.onerror = async () => {\n    socket.close();\n  };\n\n  return socket;\n}\n\nexport function useSocket() {\n  return React.useContext(SocketContext);\n}\n\nexport function useActiveUsers() {\n  const context = React.useContext(ActiveUsersContext);\n  if (!context) {\n    throw new Error(`useActiveUsers must be used within a SocketProvider`);\n  }\n\n  return context;\n}\n"]},"metadata":{},"sourceType":"module"}